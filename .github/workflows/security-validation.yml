name: Security Validation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  cryptographic-validation:
    name: Cryptographic Security Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Validate secure algorithms only
      run: |
        echo "ðŸ” Validating cryptographic algorithm usage..."
        
        # Check for deprecated algorithms
        if grep -r "MD5\|SHA-1\|SHA1" src/main/java --include="*.java" | grep -v "// " | grep -v "/\*" | grep -v "SHA-1.*deprecated\|MD5.*deprecated"; then
          echo "âŒ Deprecated cryptographic algorithms detected!"
          echo "   MD5 and SHA-1 are not allowed due to collision vulnerabilities"
          exit 1
        else
          echo "âœ… No deprecated algorithms found"
        fi
        
        # Check for secure algorithms
        if grep -r "SHA-256\|SHA-3-256\|SHA-512\|SHA-3-512" src/main/java --include="*.java"; then
          echo "âœ… Secure algorithms detected"
        else
          echo "âš ï¸  No secure algorithms found in source code"
        fi
        
    - name: Validate SSL configuration
      run: |
        echo "ðŸ”’ Validating SSL/TLS configuration..."
        
        # Check for HTTPS enforcement
        if grep -r "server.port=8443\|https" src/main/resources --include="*.properties"; then
          echo "âœ… HTTPS configuration found"
        else
          echo "âš ï¸  HTTPS configuration not detected"
        fi
        
        # Check for SSL keystore
        if [ -f "src/main/resources/keystore.p12" ]; then
          echo "âœ… SSL keystore present"
        else
          echo "âš ï¸  SSL keystore not found"
        fi
        
    - name: Validate input sanitization
      run: |
        echo "ðŸ›¡ï¸  Validating input sanitization practices..."
        
        # Check for input validation
        if grep -r "validate\|sanitize\|requireNonNull" src/main/java --include="*.java"; then
          echo "âœ… Input validation patterns found"
        else
          echo "âš ï¸  Input validation not detected"
        fi
        
    - name: Check error handling security
      run: |
        echo "ðŸš« Validating secure error handling..."
        
        # Check for secure exception handling
        if grep -r "printStackTrace\|getCause().getMessage()" src/main/java --include="*.java"; then
          echo "âŒ Insecure error handling detected!"
          echo "   Stack traces and detailed error messages should not be exposed"
          exit 1
        else
          echo "âœ… No insecure error handling patterns found"
        fi
        
    - name: Validate logging security
      run: |
        echo "ðŸ“ Validating secure logging practices..."
        
        # Check for sensitive data in logs
        if grep -r "log.*password\|log.*secret\|log.*key" src/main/java --include="*.java" | grep -v "// " | grep -v "/\*"; then
          echo "âŒ Potential sensitive data logging detected!"
          exit 1
        else
          echo "âœ… No sensitive data logging patterns found"
        fi
        
  compliance-check:
    name: CS-305 Compliance Check
    runs-on: ubuntu-latest
    needs: cryptographic-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate assignment requirements
      run: |
        echo "ðŸ“š Validating CS-305 assignment requirements..."
        
        # Check for required components
        REQUIRED_FILES=(
          "src/main/java/com/snhu/sslserver/ServerApplication.java"
          "src/main/resources/application.properties"
          "src/main/resources/keystore.p12"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Required file found: $file"
          else
            echo "âŒ Required file missing: $file"
            exit 1
          fi
        done
        
    - name: Validate hash functionality
      run: |
        echo "ðŸ”¢ Validating hash functionality requirements..."
        
        # Check for hash-related code
        if grep -r "hash\|Hash\|MessageDigest" src/main/java --include="*.java"; then
          echo "âœ… Hash functionality detected"
        else
          echo "âŒ Hash functionality not found"
          exit 1
        fi
        
    - name: Validate REST endpoint
      run: |
        echo "ðŸŒ Validating REST endpoint requirements..."
        
        # Check for /hash endpoint
        if grep -r "@RequestMapping.*hash\|@GetMapping.*hash" src/main/java --include="*.java"; then
          echo "âœ… Hash endpoint detected"
        else
          echo "âŒ Hash endpoint not found"
          exit 1
        fi
        
    - name: Generate compliance report
      run: |
        echo "ðŸ“Š Generating compliance report..."
        echo "## CS-305 Compliance Report" > compliance-report.md
        echo "- âœ… Cryptographic algorithms validated" >> compliance-report.md
        echo "- âœ… SSL/TLS configuration checked" >> compliance-report.md
        echo "- âœ… Input validation verified" >> compliance-report.md
        echo "- âœ… Error handling security confirmed" >> compliance-report.md
        echo "- âœ… Assignment requirements met" >> compliance-report.md
        
    - name: Upload compliance report
      uses: actions/upload-artifact@v3
      with:
        name: compliance-report
        path: compliance-report.md